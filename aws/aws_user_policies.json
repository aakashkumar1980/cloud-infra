{
  "ABOUT": [
    "┌─────────────────────────────────────────────────────────────────┐",
    "│ Allow Policies                                                  │",
    "│   ├── VPC       - VPCs, subnets, IGW, NAT, routes, SG           │",
    "│   ├── EC2       - Instances, volumes, key pairs                 │",
    "│   ├── KMS       - Key management and crypto operations          │",
    "│   ├── Secrets   - Secrets Manager lifecycle                     │",
    "│   ├── IAMRole   - Create/manage roles, SLR                      │",
    "│   ├── IAMPass   - Pass *-role-* to EC2/Lambda/ECS only          │",
    "│   ├── IAMPol    - Create/manage policies                        │",
    "│   ├── IAMProf   - Instance profiles for EC2                     │",
    "│   ├── IAMSvc    - Service account users + keys + policies       │",
    "│   │     └── /service-accounts/* with *kms-decrypt* only         │",
    "│   ├── Logs      - CloudWatch log groups and streams             │",
    "│   └── SSM       - Parameter Store, Session Manager              │",
    "├─────────────────────────────────────────────────────────────────┤",
    "│ Deny Policies (Cost Protection)                                 │",
    "│   ├── DenyRgn   - Only us-east-1, eu-west-2                     │",
    "│   ├── DenyEC2   - Only t3/t3a/t4g micro/small/med               │",
    "│   ├── DenyVol   - Max 100GB EBS                                 │",
    "│   └── DenyIOPS  - Block io1/io2 IOPS volumes                    │",
    "└─────────────────────────────────────────────────────────────────┘"
  ],
  "Version": "2012-10-17",
  "Statement": [
    {"Sid": "VPC", "Effect": "Allow", "Action": [
      "ec2:*Vpc*", "ec2:*Subnet*", "ec2:*InternetGateway*",
      "ec2:*NatGateway*", "ec2:*Address", "ec2:*RouteTable*",
      "ec2:*Route", "ec2:*SecurityGroup*"
    ], "Resource": "*", "Condition": {"StringEquals": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]}}},

    {"Sid": "EC2", "Effect": "Allow", "Action": [
      "ec2:Describe*", "ec2:*Instances", "ec2:GetPasswordData",
      "ec2:ModifyInstanceAttribute", "ec2:*IamInstanceProfile*",
      "ec2:*Volume*", "ec2:*KeyPair", "ec2:*Tags"
    ], "Resource": "*", "Condition": {"StringEquals": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]}}},

    {"Sid": "KMS", "Effect": "Allow", "Action": [
      "kms:Create*", "kms:Delete*", "kms:Describe*", "kms:Get*",
      "kms:List*", "kms:Put*", "kms:Schedule*", "kms:Cancel*",
      "kms:Tag*", "kms:Untag*", "kms:Update*", "kms:Enable*",
      "kms:Disable*", "kms:Replicate*", "kms:Encrypt", "kms:Decrypt",
      "kms:GenerateDataKey*", "kms:GetPublicKey"
    ], "Resource": "*", "Condition": {"StringEquals": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]}}},

    {"Sid": "Secrets", "Effect": "Allow", "Action": [
      "secretsmanager:*Secret*", "secretsmanager:Tag*", "secretsmanager:Untag*",
      "secretsmanager:List*", "secretsmanager:GetRandomPassword"
    ], "Resource": "*", "Condition": {"StringEquals": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]}}},

    {"Sid": "IAMRole", "Effect": "Allow", "Action": [
      "iam:CreateRole", "iam:DeleteRole", "iam:GetRole", "iam:ListRoles",
      "iam:TagRole", "iam:UntagRole", "iam:UpdateRole*",
      "iam:*RolePolicy*", "iam:*ServiceLinkedRole*"
    ], "Resource": "*"},

    {"Sid": "IAMPass", "Effect": "Allow", "Action": "iam:PassRole",
      "Resource": "arn:aws:iam::*:role/*-role-*",
      "Condition": {"StringEquals": {"iam:PassedToService": [
        "ec2.amazonaws.com", "lambda.amazonaws.com", "ecs-tasks.amazonaws.com"]}}},

    {"Sid": "IAMPol", "Effect": "Allow", "Action": [
      "iam:*Policy", "iam:*Policy*"
    ], "Resource": "*"},

    {"Sid": "IAMProf", "Effect": "Allow", "Action": "iam:*InstanceProfile*", "Resource": "*"},

    {"Sid": "IAMSvc", "Effect": "Allow", "Action": [
      "iam:*User", "iam:*User*", "iam:*AccessKey*"
    ], "Resource": "arn:aws:iam::*:user/service-accounts/*"},

    {"Sid": "IAMSvcPol", "Effect": "Allow", "Action": [
      "iam:AttachUserPolicy", "iam:DetachUserPolicy", "iam:ListAttachedUserPolicies"
    ], "Resource": "arn:aws:iam::*:user/service-accounts/*",
      "Condition": {"ArnLike": {"iam:PolicyArn": "arn:aws:iam::*:policy/*kms-decrypt*"}}},

    {"Sid": "Logs", "Effect": "Allow", "Action": "logs:*",
      "Resource": "*", "Condition": {"StringEquals": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]}}},

    {"Sid": "SSM", "Effect": "Allow", "Action": [
      "ssm:*Parameter*", "ssm:*Tags*", "ssm:*Session*",
      "ssm:*Command*", "ssm:*Document*", "ssm:GetConnectionStatus"
    ], "Resource": "*", "Condition": {"StringEquals": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]}}},

    {"Sid": "DenyRgn", "Effect": "Deny", "Action": "*", "Resource": "*",
      "Condition": {"StringNotEqualsIfExists": {"aws:RequestedRegion": ["eu-west-2", "us-east-1"]},
      "ForAnyValue:StringNotEqualsIfExists": {"aws:CalledVia": ["cloudformation.amazonaws.com"]},
      "Bool": {"aws:ViaAWSService": "false"}}},

    {"Sid": "DenyEC2", "Effect": "Deny", "Action": "ec2:RunInstances",
      "Resource": "arn:aws:ec2:*:*:instance/*",
      "Condition": {"ForAnyValue:StringNotLike": {"ec2:InstanceType": [
        "t3.micro", "t3.small", "t3.medium",
        "t3a.micro", "t3a.small", "t3a.medium",
        "t4g.micro", "t4g.small", "t4g.medium"]}}},

    {"Sid": "DenyVol", "Effect": "Deny",
      "Action": ["ec2:CreateVolume", "ec2:ModifyVolume", "ec2:RunInstances"],
      "Resource": "*", "Condition": {"NumericGreaterThan": {"ec2:VolumeSize": "100"}}},

    {"Sid": "DenyIOPS", "Effect": "Deny",
      "Action": ["ec2:CreateVolume", "ec2:ModifyVolume", "ec2:RunInstances"],
      "Resource": "*", "Condition": {"StringEquals": {"ec2:VolumeType": ["io1", "io2"]}}}
  ]
}
