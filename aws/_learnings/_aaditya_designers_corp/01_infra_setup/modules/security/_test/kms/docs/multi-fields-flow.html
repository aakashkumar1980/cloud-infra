<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Fields Encryption Flow</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #fff;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.2em;
      background: linear-gradient(90deg, #00d4ff, #7b2ff7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 40px;
      font-size: 1.1em;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .panel {
      flex: 1;
      min-width: 580px;
      max-width: 650px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .panel-icon {
      font-size: 2.5em;
    }

    .panel-title {
      font-size: 1.5em;
      font-weight: 600;
    }

    .client-panel .panel-title { color: #00d4ff; }
    .server-panel .panel-title { color: #ff6b6b; }

    .step {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 22px;
      top: 50px;
      width: 2px;
      height: calc(100% - 30px);
      background: linear-gradient(180deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
    }

    .step-number {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      flex-shrink: 0;
      z-index: 1;
    }

    .client-panel .step-number {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }

    .server-panel .step-number {
      background: linear-gradient(135deg, #ff6b6b, #cc4444);
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    .step-content {
      flex: 1;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 15px 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .step-title {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-desc {
      color: #aaa;
      font-size: 0.95em;
      line-height: 1.5;
    }

    .key-icon {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .key-rsa-pub {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
    }

    .key-rsa-priv {
      background: linear-gradient(135deg, #9C27B0, #6A1B9A);
      color: white;
    }

    .key-dek {
      background: linear-gradient(135deg, #FF9800, #F57C00);
      color: white;
    }

    .key-dek-encrypted {
      background: linear-gradient(135deg, #E91E63, #AD1457);
      color: white;
    }

    .key-aes {
      background: linear-gradient(135deg, #2196F3, #1565C0);
      color: white;
    }

    .key-kms {
      background: linear-gradient(135deg, #673AB7, #4527A0);
      color: white;
    }

    .code-block {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      padding: 12px 15px;
      margin-top: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      overflow-x: auto;
      border-left: 3px solid;
    }

    .client-panel .code-block { border-left-color: #00d4ff; }
    .server-panel .code-block { border-left-color: #ff6b6b; }

    .code-block code {
      color: #e0e0e0;
    }

    .code-block .comment { color: #6a9955; }
    .code-block .keyword { color: #569cd6; }
    .code-block .string { color: #ce9178; }
    .code-block .var { color: #9cdcfe; }
    .code-block .method { color: #dcdcaa; }

    .arrow-connector {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px 0;
    }

    .arrow-down {
      font-size: 2em;
      color: #666;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(5px); }
    }

    .data-flow {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    .data-flow-title {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .data-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 0.9em;
    }

    .data-item:last-child { margin-bottom: 0; }

    .data-label {
      color: #888;
      min-width: 80px;
    }

    .data-value {
      color: #fff;
      font-family: monospace;
      word-break: break-all;
    }

    .http-request {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 153, 204, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 30px 0;
    }

    .http-title {
      color: #00d4ff;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .http-method {
      background: #4CAF50;
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.85em;
    }

    .http-url {
      color: #fff;
      font-family: monospace;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
    }

    .legend-title {
      width: 100%;
      text-align: center;
      color: #888;
      margin-bottom: 10px;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pii-field {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      background: rgba(255, 193, 7, 0.2);
      border: 1px solid rgba(255, 193, 7, 0.4);
      border-radius: 4px;
      color: #FFC107;
      font-size: 0.85em;
    }

    .encrypted-field {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.4);
      border-radius: 4px;
      color: #4CAF50;
      font-size: 0.85em;
    }

    .loop-indicator {
      background: rgba(255, 152, 0, 0.15);
      border: 1px dashed rgba(255, 152, 0, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
    }

    .loop-header {
      color: #FF9800;
      font-size: 0.85em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .security-note {
      background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(103, 58, 183, 0.1));
      border: 1px solid rgba(156, 39, 176, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .security-note-icon {
      font-size: 1.5em;
    }

    .security-note-text {
      color: #ce93d8;
      font-size: 0.9em;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <h1>Multi-Fields Hybrid Encryption Flow</h1>
  <p class="subtitle">Client-side encryption with AWS KMS server-side decryption</p>

  <div class="container">
    <!-- CLIENT PANEL -->
    <div class="panel client-panel">
      <div class="panel-header">
        <span class="panel-icon">üíª</span>
        <span class="panel-title">CLIENT (Encryption)</span>
      </div>

      <!-- Step 1 -->
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-title">
            Load RSA Public Key
            <span class="key-icon key-rsa-pub">üîë RSA-4096 Public</span>
          </div>
          <div class="step-desc">
            Load the server's RSA public key from PEM file. This key will be used to encrypt the DEK.
          </div>
          <div class="code-block">
            <code>
              <span class="var">publicKey</span> = <span class="method">loadPublicKey</span>(<span class="string">"public-key.pem"</span>)
            </code>
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-title">
            Generate Data Encryption Key (DEK)
            <span class="key-icon key-dek">üîê DEK</span>
          </div>
          <div class="step-desc">
            Generate a random 256-bit AES key. This symmetric key will encrypt all PII fields.
          </div>
          <div class="code-block">
            <code>
              <span class="var">dataEncryptionKey</span> = <span class="method">KeyGenerator</span>.<span class="method">getInstance</span>(<span class="string">"AES"</span>)<br>
              &nbsp;&nbsp;&nbsp;&nbsp;.<span class="method">generateKey</span>() <span class="comment">// 256 bits = 32 bytes</span>
            </code>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-title">
            Encrypt DEK with RSA
            <span class="key-icon key-dek-encrypted">üîí Encrypted DEK</span>
          </div>
          <div class="step-desc">
            Wrap the DEK using RSA-OAEP-256 encryption with the public key. Output is ~512 bytes (for RSA-4096).
          </div>
          <div class="code-block">
            <code>
              <span class="comment">// RSA-OAEP-256 encryption</span><br>
              <span class="var">cipher</span> = <span class="method">Cipher</span>.<span class="method">getInstance</span>(<span class="string">"RSA/ECB/OAEPWithSHA-256..."</span>)<br>
              <span class="var">cipher</span>.<span class="method">init</span>(ENCRYPT_MODE, <span class="var">publicKey</span>)<br>
              <span class="var">encryptedDataEncryptionKey</span> = <span class="method">Base64</span>(<span class="var">cipher</span>.<span class="method">doFinal</span>(<span class="var">dataEncryptionKey</span>))
            </code>
          </div>
        </div>
      </div>

      <!-- Step 4 -->
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-title">
            Encrypt PII Fields with DEK
            <span class="key-icon key-aes">üîê AES-256-GCM</span>
          </div>
          <div class="step-desc">
            Encrypt each sensitive field using AES-256-GCM. Each field gets a unique IV.
          </div>

          <div class="loop-indicator">
            <div class="loop-header">üîÑ For each PII field (DOB, Card, SSN):</div>
            <div class="code-block">
              <code>
                <span class="var">iv</span> = <span class="method">SecureRandom</span>.<span class="method">generate</span>(12) <span class="comment">// 96 bits</span><br>
                <span class="var">cipher</span> = <span class="method">Cipher</span>.<span class="method">getInstance</span>(<span class="string">"AES/GCM/NoPadding"</span>)<br>
                <span class="var">cipher</span>.<span class="method">init</span>(ENCRYPT_MODE, <span class="var">dataEncryptionKey</span>, <span class="keyword">new</span> GCMParameterSpec(128, <span class="var">iv</span>))<br><br>
                <span class="var">ciphertext</span> = <span class="var">cipher</span>.<span class="method">doFinal</span>(<span class="var">plaintext</span>)<br>
                <span class="var">encryptedField</span> = <span class="method">Base64</span>(<span class="var">iv</span>) + <span class="string">"."</span> + <span class="method">Base64</span>(<span class="var">ciphertext</span>) + <span class="string">"."</span> + <span class="method">Base64</span>(<span class="var">authTag</span>)
              </code>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5 -->
      <div class="step">
        <div class="step-number">5</div>
        <div class="step-content">
          <div class="step-title">
            Send HTTP Request
          </div>
          <div class="step-desc">
            Send the encrypted DEK in header and encrypted fields in JSON body.
          </div>

          <div class="data-flow">
            <div class="data-flow-title">Request Structure</div>
            <div class="data-item">
              <span class="data-label">Header:</span>
              <span class="data-value">X-Encryption-Key: <span class="key-icon key-dek-encrypted" style="font-size: 0.9em;">BASE64(encryptedDEK)</span></span>
            </div>
            <div class="data-item">
              <span class="data-label">Body:</span>
              <span class="data-value">
                {<br>
                &nbsp;&nbsp;"dateOfBirth": <span class="encrypted-field">üîí IV.Cipher.Tag</span>,<br>
                &nbsp;&nbsp;"creditCard": <span class="encrypted-field">üîí IV.Cipher.Tag</span>,<br>
                &nbsp;&nbsp;"ssn": <span class="encrypted-field">üîí IV.Cipher.Tag</span><br>
                }
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SERVER PANEL -->
    <div class="panel server-panel">
      <div class="panel-header">
        <span class="panel-icon">üñ•Ô∏è</span>
        <span class="panel-title">SERVER (Decryption)</span>
      </div>

      <!-- Step 1 -->
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-title">
            Receive HTTP Request
          </div>
          <div class="step-desc">
            Extract the encrypted DEK from header and encrypted fields from JSON body.
          </div>
          <div class="code-block">
            <code>
              <span class="var">encryptedDataEncryptionKey</span> = request.<span class="method">getHeader</span>(<span class="string">"X-Encryption-Key"</span>)<br>
              <span class="var">encryptedFields</span> = request.<span class="method">getBody</span>()
            </code>
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-title">
            KMS Decrypt DEK
            <span class="key-icon key-kms">‚òÅÔ∏è AWS KMS</span>
            <span class="key-icon key-rsa-priv">üîë RSA Private (HSM)</span>
          </div>
          <div class="step-desc">
            Send encrypted DEK to AWS KMS for RSA decryption. Private key never leaves the HSM!
          </div>
          <div class="code-block">
            <code>
              <span class="comment">// AWS KMS API call (1 call per request)</span><br>
              DecryptRequest kmsRequest = DecryptRequest.<span class="method">builder</span>()<br>
              &nbsp;&nbsp;.<span class="method">keyId</span>(<span class="var">kmsKeyArn</span>)<br>
              &nbsp;&nbsp;.<span class="method">ciphertextBlob</span>(<span class="method">Base64.decode</span>(<span class="var">encryptedDataEncryptionKey</span>))<br>
              &nbsp;&nbsp;.<span class="method">encryptionAlgorithm</span>(RSAES_OAEP_SHA_256)<br>
              &nbsp;&nbsp;.<span class="method">build</span>();<br><br>
              <span class="var">dataEncryptionKey</span> = kmsClient.<span class="method">decrypt</span>(kmsRequest).<span class="method">plaintext</span>()
            </code>
          </div>

          <div class="security-note">
            <span class="security-note-icon">üõ°Ô∏è</span>
            <span class="security-note-text">
              <strong>Security:</strong> The RSA private key is stored in AWS KMS HSM and <em>never</em> leaves it.
              Only the encrypted DEK is sent to KMS, and only the decrypted DEK is returned.
            </span>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-title">
            Decrypt PII Fields with DEK
            <span class="key-icon key-aes">üîì AES-256-GCM</span>
          </div>
          <div class="step-desc">
            Decrypt each encrypted field locally using the recovered DEK.
          </div>

          <div class="loop-indicator">
            <div class="loop-header">üîÑ For each encrypted field:</div>
            <div class="code-block">
              <code>
                <span class="comment">// Parse: "BASE64(iv).BASE64(ciphertext).BASE64(authTag)"</span><br>
                String[] parts = <span class="var">encryptedField</span>.<span class="method">split</span>(<span class="string">"\\."</span>)<br>
                <span class="var">iv</span> = <span class="method">Base64.decode</span>(parts[0])<br>
                <span class="var">ciphertext</span> = <span class="method">Base64.decode</span>(parts[1])<br>
                <span class="var">authTag</span> = <span class="method">Base64.decode</span>(parts[2])<br><br>
                <span class="var">cipher</span> = <span class="method">Cipher</span>.<span class="method">getInstance</span>(<span class="string">"AES/GCM/NoPadding"</span>)<br>
                <span class="var">cipher</span>.<span class="method">init</span>(DECRYPT_MODE, <span class="var">dataEncryptionKey</span>, <span class="keyword">new</span> GCMParameterSpec(128, <span class="var">iv</span>))<br>
                <span class="var">plaintext</span> = <span class="var">cipher</span>.<span class="method">doFinal</span>(<span class="var">ciphertext</span> + <span class="var">authTag</span>)
              </code>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4 -->
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-title">
            Process Decrypted Data
          </div>
          <div class="step-desc">
            Use the decrypted PII for business logic. Mask sensitive data in logs!
          </div>

          <div class="data-flow">
            <div class="data-flow-title">Decrypted Fields</div>
            <div class="data-item">
              <span class="data-label">DOB:</span>
              <span class="data-value"><span class="pii-field">üìÖ 1990-05-15</span></span>
            </div>
            <div class="data-item">
              <span class="data-label">Card:</span>
              <span class="data-value"><span class="pii-field">üí≥ 4111-1111-1111-1111</span> ‚Üí Log: ****1111</span>
            </div>
            <div class="data-item">
              <span class="data-label">SSN:</span>
              <span class="data-value"><span class="pii-field">üî¢ 123-45-6789</span> ‚Üí Log: ***-**-6789</span>
            </div>
          </div>

          <div class="code-block">
            <code>
              log.<span class="method">info</span>(<span class="string">"Decrypted PII - DOB: {} | Card: {} | SSN: {}"</span>,<br>
              &nbsp;&nbsp;&nbsp;&nbsp;dob, utils.<span class="method">maskCard</span>(card), utils.<span class="method">maskSsn</span>(ssn));
            </code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-title">Key Legend</div>
    <div class="legend-item">
      <span class="key-icon key-rsa-pub">üîë RSA Public</span>
      <span style="color: #888;">Client uses to encrypt DEK</span>
    </div>
    <div class="legend-item">
      <span class="key-icon key-rsa-priv">üîë RSA Private</span>
      <span style="color: #888;">Stays in KMS HSM</span>
    </div>
    <div class="legend-item">
      <span class="key-icon key-dek">üîê DEK</span>
      <span style="color: #888;">AES-256 Data Encryption Key</span>
    </div>
    <div class="legend-item">
      <span class="key-icon key-dek-encrypted">üîí Encrypted DEK</span>
      <span style="color: #888;">RSA-encrypted DEK (~512 bytes)</span>
    </div>
    <div class="legend-item">
      <span class="key-icon key-aes">üîê AES-GCM</span>
      <span style="color: #888;">Field encryption/decryption</span>
    </div>
    <div class="legend-item">
      <span class="key-icon key-kms">‚òÅÔ∏è AWS KMS</span>
      <span style="color: #888;">Cloud HSM for RSA decryption</span>
    </div>
  </div>

  <!-- Summary -->
  <div style="max-width: 1000px; margin: 40px auto; text-align: center;">
    <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px;">
      <h3 style="color: #00d4ff; margin-bottom: 15px;">üìä Summary</h3>
      <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
        <div>
          <div style="font-size: 2em; color: #4CAF50;">1</div>
          <div style="color: #888;">KMS API Call</div>
        </div>
        <div>
          <div style="font-size: 2em; color: #FF9800;">256-bit</div>
          <div style="color: #888;">AES Key (DEK)</div>
        </div>
        <div>
          <div style="font-size: 2em; color: #2196F3;">RSA-4096</div>
          <div style="color: #888;">Key Protection</div>
        </div>
        <div>
          <div style="font-size: 2em; color: #9C27B0;">AES-GCM</div>
          <div style="color: #888;">Authenticated Encryption</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
